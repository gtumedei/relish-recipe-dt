services:
  relish:
    build: .
    image: relish:latest
    container_name: relish
    env_file:
      - .env
    # The container's database URL must use the MongoDB container name
    environment:
      - DATABASE_URL=mongodb://admin:${ADMIN_PASSWORD:?Missing ADMIN_PASSWORD}@relish-mongod:27017/relish?authSource=admin&directConnection=true
    ports:
      - "80:8000"
    volumes:
      - relish_tmp_data:/app/tmp
    networks:
      - relish-net
    depends_on:
      relish-db-push:
        condition: service_completed_successfully

  mongod:
    image: mongodb/mongodb-community-server:latest
    container_name: relish-mongod
    environment:
      MONGODB_INITDB_ROOT_USERNAME: admin
      MONGODB_INITDB_ROOT_PASSWORD: ${ADMIN_PASSWORD:?Missing ADMIN_PASSWORD}
      MONGOT_PASSWORD: ${MONGOT_PASSWORD:?Missing MONGOT_PASSWORD}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:?Missing ADMIN_PASSWORD}
    command: >-
      mongod
      --config /etc/mongod.conf
      --replSetMember=mongod.relish-net:27017
    ports:
      - "27017:27017"
    volumes:
      - mongod_data:/data/db
      - mongod_configdb:/data/configdb
      - ./mongo-config/mongod.conf:/etc/mongod.conf:ro
      - ./keyfile:/keyfile:ro
      - ./mongo-config/init-mongo.sh:/docker-entrypoint-initdb.d/init-mongo.sh:ro
    networks:
      - relish-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  mongot:
    image: mongodb/mongodb-community-search:latest
    container_name: relish-mongot
    ports:
      - "27028:27028" # gRPC server port
      - "8080:8080" # Health check port
      - "9946:9946" # Metrics port
    volumes:
      - mongot_data:/data/mongot
      - ./mongo-config/mongot.conf:/mongot-community/config.default.yml:ro
      - ./passwordFile:/passwordFile:ro
    networks:
      - relish-net
    depends_on:
      mongod:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://relish-mongot.relish-net:9946/metrics",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Service to generate keyfile and password file if they don't exist
  relish-setup-generator:
    image: alpine:latest
    container_name: relish-setup-generator
    volumes:
      - .:/workspace
    working_dir: /workspace
    environment:
      - MONGOT_PASSWORD=${MONGOT_PASSWORD:?Missing MONGOT_PASSWORD}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:?Missing ADMIN_PASSWORD}
    command: >
      sh -c "
        echo 'Setting up security files...';
        echo 'Admin password: [HIDDEN]';
        echo 'Mongot password: [HIDDEN]';

        # Generate keyfile if it doesn't exist
        if [ ! -f keyfile ]; then
          echo 'Generating keyfile...';
          apk add --no-cache openssl;
          openssl rand -base64 756 > keyfile;
          chmod 400 keyfile;
          echo 'Keyfile generated successfully';
        else
          echo 'Keyfile already exists, skipping generation';
        fi;

        # Create password file with specified password
        echo 'Creating password file...';
        echo -n "$MONGOT_PASSWORD" > passwordFile;
        chmod 600 passwordFile;
        echo 'Password file created successfully';

        echo 'Setup completed successfully';
      "
    restart: "no"
    profiles:
      - setup

  # Service to setup the database using Prisma
  relish-db-push:
    build: .
    image: relish:latest
    container_name: relish-db-push
    command: >
      sh -c "
        cd ../..
        deno task db:push
      "
    env_file:
      - .env
    # The container's database URL must use the MongoDB container name
    environment:
      - DATABASE_URL=mongodb://admin:${ADMIN_PASSWORD:?Missing ADMIN_PASSWORD}@relish-mongod:27017/relish?authSource=admin&directConnection=true
    networks:
      - relish-net
    depends_on:
      mongot:
        condition: service_healthy
    restart: "no"

volumes:
  relish_tmp_data:
  mongod_data:
  mongod_configdb:
  mongot_data:

networks:
  relish-net:
    name: relish-net
